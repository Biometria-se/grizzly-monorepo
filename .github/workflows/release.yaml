# build with uv build --out-dir dist/ --package <package> --wheel --sdist
# without --wheel and --sdist, the wheel will be built from the source distribution, and the custom hatch build hooks in ../hatch_build.py will be
# missing.
name: release

on:
  pull_request:
    types:
      - closed
    branches:
      - main

  workflow_dispatch:
    inputs:
      pr-number:
        description: 'PR number to release'
        required: true
        type: number
      dry-run:
        description: 'dry run (no actual release)'
        required: false
        type: boolean

jobs:
  prerequisites:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       (contains(github.event.pull_request.labels.*.name, 'major') ||
        contains(github.event.pull_request.labels.*.name, 'minor') ||
        contains(github.event.pull_request.labels.*.name, 'patch')))
    outputs:
      should-release: ${{ steps.check-pr.outputs.should-release }}
      version-bump: ${{ steps.check-pr.outputs.version-bump }}
      pr-number: ${{ steps.check-pr.outputs.pr-number }}
      commit-sha: ${{ steps.check-pr.outputs.commit-sha }}
      base-commit-sha: ${{ steps.check-pr.outputs.base-commit-sha }}
      changes_uv: ${{ steps.mapper.outputs.changes_uv }}
      changes_npm: ${{ steps.mapper.outputs.changes_npm }}

    steps:
    - uses: actions/checkout@v4

    - name: "run setup-uv-job"
      uses: ./.github/actions/setup-uv-job

    - name: check pull request
      id: check-pr
      uses: actions/github-script@v7
      with:
        script: |
          let pr;
          let commitSha;

          if (context.eventName === 'workflow_dispatch') {
            // Manual trigger: get PR by number
            const prNumber = context.payload.inputs['pr-number'];
            console.log(`manual trigger for PR #${prNumber}`);

            const prResponse = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            pr = prResponse.data;

            // Verify PR is merged
            if (!pr.merged) {
              core.setFailed(`PR #${prNumber} is not merged`);
              core.setOutput('should-release', 'false');
              return;
            }

            commitSha = pr.merge_commit_sha;
            console.log(`PR #${prNumber} merged at commit: ${commitSha}`);
          } else {
            // Automatic trigger: PR was just merged
            pr = context.payload.pull_request;
            commitSha = pr.merge_commit_sha;
            console.log(`PR #${pr.number} merged at commit: ${commitSha}`);
          }

          const labels = pr.labels.map(label => label.name);
          console.log(`PR #${pr.number} labels: ${labels}`);

          // Get the base commit (the commit that the PR was merged onto)
          const baseCommitSha = pr.base.sha;
          console.log(`PR base commit: ${baseCommitSha}`);

          // Check for version bump labels
          const versionLabels = ['major', 'minor', 'patch'];
          const versionLabel = versionLabels.find(label => labels.includes(label));

          if (versionLabel) {
            console.log(`found version label: ${versionLabel}`);
            core.setOutput('should-release', 'true');
            core.setOutput('version-bump', versionLabel);
            core.setOutput('pr-number', pr.number);
            core.setOutput('commit-sha', commitSha);
            core.setOutput('base-commit-sha', baseCommitSha);
          } else {
            console.log('no version release label (major/minor/patch) found');
            core.setOutput('should-release', 'false');
            core.setFailed(`no version release label found on PR #${pr.number}`);
          }

    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: ./.github/changes-filter.yaml
        ref: ${{ steps.check-pr.outputs.commit-sha }}
        base: ${{ steps.check-pr.outputs.base-commit-sha }}

    - name: map changed directories to packages
      if: steps.filter.outputs.changes != '[]'
      id: mapper
      run: |
        uv run ./extras/scripts/map-changes.py --changes '${{ steps.filter.outputs.changes }}' --force false

  uv-release:
    name: "release / ${{ matrix.changes.package }}"
    needs: [prerequisites]
    if: needs.prerequisites.outputs.should-release == 'true' && needs.prerequisites.outputs.changes_uv != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        changes: ${{ fromJson(needs.prerequisites.outputs.changes_uv) }}

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.prerequisites.outputs.commit-sha }}
        fetch-tags: true
        fetch-depth: 0

    - name: "setup release"
      uses: ./.github/actions/setup-release
      with:
        project: ${{ matrix.changes.directory }}
        version-bump: ${{ needs.prerequisites.outputs.version-bump }}

    - name: build
      run: uv build --package ${{ matrix.changes.package }} --sdist --wheel

  npm-release:
    name: "release / ${{ matrix.changes.package }}"
    needs: [prerequisites]
    if: needs.prerequisites.outputs.should-release == 'true' && needs.prerequisites.outputs.changes_npm != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        changes: ${{ fromJson(needs.prerequisites.outputs.changes_npm) }}

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.prerequisites.outputs.commit-sha }}
        fetch-tags: true
        fetch-depth: 0

    - uses: actions/setup-node@v5
      with:
        cache: 'npm'
        node-version: 24
        cache-dependency-path: "${{ matrix.changes.directory }}/package-lock.json"

    - name: "setup release"
      id: setup-release
      uses: ./.github/actions/setup-release
      with:
        project: ${{ matrix.changes.directory }}
        version-bump: ${{ needs.prerequisites.outputs.version-bump }}

    - name: install dependencies
      working-directory: ${{ matrix.changes.directory }}
      run: npm install

    - name: bump package version
      run: npm version ${{ steps.setup-release.outputs.next-release-version }}

    - name: build
      run: npx @vscode/vsce package

  documentation:
    name: "documentation"
    needs:
    - prerequisites
    - uv-release
    - npm-release
    if: success()
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.prerequisites.outputs.commit-sha }}
        fetch-tags: true
        fetch-depth: 0

    - uses: actions/setup-node@v5
      with:
        cache: 'npm'
        node-version: 24
        cache-dependency-path: "${{ matrix.changes.directory }}/package-lock.json"

    - name: "setup release"
      id: setup-release
      uses: ./.github/actions/setup-release
      with:
        project: ${{ matrix.changes.directory }}
        version-bump: ${{ needs.prerequisites.outputs.version-bump }}

